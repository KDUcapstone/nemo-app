# ======= nemo.dev.conf (self-contained) =======
events { worker_connections 1024; }

http {
  # 웹소켓 업그레이드용 map 은 http 블록 안에 둬야 합니다.
  map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
  }

  log_format dev '$remote_addr - $time_local "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent"';
  access_log logs/access.log dev;
  error_log  logs/error.log;

  gzip on;
  gzip_types text/plain text/css application/javascript application/json application/xml;

  upstream flutter_dev { server 127.0.0.1:53000; }
  upstream spring_api  { server 127.0.0.1:8080;  }

  server {
    listen 8085;
    server_name localhost;

    # 프론트: Flutter dev 서버로 프록시
    location / {
      proxy_pass http://flutter_dev;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

      # 핫리로드/웹소켓
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
      proxy_read_timeout 120s;
    }

    # API: Spring Boot로 프록시
    location /api/ {
      proxy_pass http://spring_api;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

      client_max_body_size 50m;   # 업로드 대비
      proxy_read_timeout 120s;
    }
  }
}
